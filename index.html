<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>C·∫≠p nh·∫≠t Gi√°/T·ªìn Kho</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #f6f6f7;
        --card: #fff;
        --text: #202223;
        --muted: #6d7175;
        --border: #e1e3e5;
        --primary: #008060;
        --radius: 12px;
      }
      body.dark {
        --bg: #0f172a;
        --card: #020617;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --border: #1e293b;
        --primary: #10b981;
      }
      body {
        margin: 0;
        font-family: Inter, system-ui;
        background: var(--bg);
        color: var(--text);
      }
      .container {
        max-width: 1200px;
        margin: auto;
        padding: 24px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 24px;
      }
      h1 {
        margin-bottom: 20px;
        text-align: center;
      }
      button {
        cursor: pointer;
        font-weight: 600;
      }
      button.main {
        background: var(--primary);
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 10px;
        transition: 0.2s;
      }
      button.main:hover {
        opacity: 0.85;
      }
      button.outline {
        background: transparent;
        color: var(--text);
        border: 1px solid var(--border);
        padding: 10px 16px;
        border-radius: 10px;
        transition: 0.2s;
      }
      button.outline:hover {
        background: var(--primary);
        color: #fff;
        border: 1px solid var(--primary);
      }
      .toggle {
        float: right;
        margin-bottom: 10px;
      }
      .file-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
      }
      .file-btn input[type="file"] {
        display: none;
      }
      .file-btn {
        display: inline-block;
        padding: 12px 20px;
        border: 2px dashed var(--primary);
        border-radius: 10px;
        background: #fff;
        color: var(--primary);
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        text-align: center;
        transition: 0.2s;
      }
      .file-btn:hover {
        background: var(--primary);
        color: #fff;
        border-color: #006644;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      .file-name {
        font-size: 13px;
        color: var(--muted);
      }
      .vendor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }
      .field {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .field label {
        font-size: 13px;
        color: var(--muted);
      }
      .field input {
        height: 40px;
        padding: 0 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
      }
      .field input:focus {
        outline: none;
        border-color: var(--primary);
      }
      .actions {
        margin-top: 20px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }
      .table-wrap {
        margin-top: 20px;
        border: 1px solid var(--border);
        border-radius: 10px;
        max-height: 320px;
        overflow: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        table-layout: fixed;
      }
      th,
      td {
        padding: 10px;
        border-bottom: 1px solid var(--border);
        text-align: center;
        vertical-align: middle;
      }
      th {
        background: rgba(0, 0, 0, 0.05);
      }
      .footer {
        text-align: center;
        font-size: 12px;
        color: var(--muted);
        margin-top: 20px;
      }
      select,
      input[type="number"] {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      .hidden {
        display: none;
      }
      .section-title {
        font-weight: 600;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button class="outline toggle" id="themeToggle">üåó</button>
      <h1>üì¶ C·∫≠p nh·∫≠t Gi√°/T·ªìn Kho</h1>

      <div class="card">
        <div class="file-row">
          <label class="file-btn">
            üìÇ Ch·ªçn file CSV
            <input type="file" id="fileInput" accept=".csv" />
          </label>
          <span class="file-name" id="fileName">Ch∆∞a ch·ªçn file</span>
        </div>

        <div class="section-title">‚ö° Ch·ªçn ph∆∞∆°ng √°n c·∫≠p nh·∫≠t Gi√°/T·ªìn kho</div>
        <div class="actions">
          <label
            ><input type="radio" name="updateMode" value="vendor" /> C·∫≠p nh·∫≠t
            theo Vendor</label
          >
          <label
            ><input type="radio" name="updateMode" value="file" /> C·∫≠p nh·∫≠t b·∫±ng
            file Gi√°/T·ªìn kho</label
          >
        </div>

        <div id="vendorSection" class="vendor-grid hidden"></div>

        <div id="fileSection" class="file-row hidden">
          <label class="file-btn">
            üìÇ Ch·ªçn file c·∫≠p nh·∫≠t XLSX
            <input type="file" id="updateFile" accept=".xlsx,.xls" />
          </label>
          <span class="file-name" id="updateFileName">Ch∆∞a ch·ªçn file</span>
          <p style="font-size: 13px; color: #6d7175; margin-top: 10px">
            üìå Ghi ch√∫: C·ªôt A = SKU | C·ªôt B = Gi√° Gi·∫£m | C·ªôt C = Gi√° G·ªëc | C·ªôt D
            = T·ªìn kho
          </p>
        </div>

        <div class="actions">
          <select id="exportType">
            <option value="csv">CSV</option>
            <option value="xlsx">XLSX</option>
          </select>
          <div>
            <label
              ><input type="radio" name="exportScope" value="updated" checked />
              Ch·ªâ c√°c m·∫´u thay ƒë·ªïi gi√°</label
            >
            <label
              ><input type="radio" name="exportScope" value="all" /> To√†n b·ªô
              file</label
            >
          </div>
        </div>

        <div class="actions">
          <button class="main" id="processBtn">‚ö° X·ª≠ l√Ω & Preview</button>
          <button class="outline" id="undoBtn">‚Ü© Undo</button>
          <button class="main" id="exportBtn">‚¨á T·∫£i file Shopify</button>
          <button class="main" id="exportMaisonBtn">
            ‚¨á T·∫£i file Maison/Gosumo
          </button>
        </div>

        <div class="table-wrap">
          <table id="previewTable"></table>
        </div>
      </div>

      <div class="footer">Designed by GiaQuyenVan</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script>
      // DARK MODE
      if (localStorage.theme === "dark") document.body.classList.add("dark");
      const themeToggle = document.getElementById("themeToggle");
      themeToggle.onclick = () => {
        document.body.classList.toggle("dark");
        localStorage.theme = document.body.classList.contains("dark")
          ? "dark"
          : "light";
      };

      // ANTI F12 / RIGHT CLICK
      document.addEventListener("contextmenu", (e) => e.preventDefault());
      document.addEventListener("keydown", (e) => {
        if (e.key === "F12" || (e.ctrlKey && e.shiftKey && e.key === "I"))
          e.preventDefault();
      });

      let master = [],
        backup = [],
        result = [],
        fileUpdateData = [];
      let updatedHandles = new Set(),
        updatedSKUSet = new Set();
      const vendors = [
        "ADIDAS",
        "FERRAGAMO",
        "FURLA",
        "PHILIPP PLEIN",
        "TED BAKER",
        "VERSACE",
        "LOCMAN",
        "GUESS",
        "MISSONI",
      ];
      const vendorSection = document.getElementById("vendorSection");
      const fileSection = document.getElementById("fileSection");

      vendors.forEach((v) => {
        vendorSection.innerHTML += `<div class="field"><label>${v} (%)</label><input type="number" id="v_${v}" min="0" max="100"></div>`;
      });

      document.querySelectorAll('input[name="updateMode"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          if (radio.value === "vendor") {
            vendorSection.classList.remove("hidden");
            fileSection.classList.add("hidden");
          } else {
            fileSection.classList.remove("hidden");
            vendorSection.classList.add("hidden");
          }
        });
      });

      const fileInput = document.getElementById("fileInput"),
        fileName = document.getElementById("fileName");
      const updateFile = document.getElementById("updateFile"),
        updateFileName = document.getElementById("updateFileName");
      const previewTable = document.getElementById("previewTable"),
        exportType = document.getElementById("exportType");

      fileInput.onchange = () => {
        const f = fileInput.files[0];
        if (!f) return;
        if (!f.name.toLowerCase().endsWith(".csv"))
          return alert("Ch·ªâ cho ph√©p file CSV!");
        fileName.textContent = f.name;
        Papa.parse(f, {
          header: true,
          skipEmptyLines: true,
          complete: (r) => {
            master = r.data;
            backup = JSON.parse(JSON.stringify(master));
            updatedHandles.clear();
            previewTable.innerHTML = "";
          },
        });
      };

      updateFile.onchange = () => {
        const f = updateFile.files[0];
        if (!f) return;
        if (
          !f.name.toLowerCase().endsWith(".xlsx") &&
          !f.name.toLowerCase().endsWith(".xls")
        )
          return alert("Ch·ªâ cho ph√©p file XLSX/XLS!");
        updateFileName.textContent = f.name;
        const reader = new FileReader();
        reader.onload = (e) => {
          const wb = XLSX.read(new Uint8Array(e.target.result), {
            type: "array",
          });
          fileUpdateData = XLSX.utils.sheet_to_json(
            wb.Sheets[wb.SheetNames[0]],
            { header: 1 }
          );
        };
        reader.readAsArrayBuffer(f);
      };

      const money = (n) => Number(n || 0).toLocaleString("vi-VN");

      document.getElementById("processBtn").onclick = processData;
      document.getElementById("undoBtn").onclick = undo;
      document.getElementById("exportBtn").onclick = exportFile;
      document.getElementById("exportMaisonBtn").onclick = exportMaison;

      function processData() {
        if (!master.length) return alert("Ch∆∞a c√≥ file master");
        const selectedMode = document.querySelector(
          'input[name="updateMode"]:checked'
        )?.value;
        if (!selectedMode) return alert("Ch·ªçn ph∆∞∆°ng √°n c·∫≠p nh·∫≠t");

        result = JSON.parse(JSON.stringify(master));
        updatedHandles.clear();
        updatedSKUSet.clear();
        let preview = [];
        let i = 1;

        if (selectedMode === "vendor") {
          result.forEach((r) => {
            if (
              r["Product Category"] !==
              "Apparel & Accessories > Jewelry > Watches"
            )
              return;
            if (!r["Variant SKU"]) return;
            const p = Number(
              document.getElementById("v_" + r.Vendor?.toUpperCase())?.value ||
                0
            );
            if (p && r["Variant Compare At Price"]) {
              if (r["Variant Price"] > r["Variant Compare At Price"])
                r["Variant Compare At Price"] = r["Variant Price"];
              r["Variant Price"] = Math.round(
                (r["Variant Compare At Price"] * (100 - p)) / 100
              );
              updatedHandles.add(r.Handle);
              preview.push({
                STT: i++,
                SKU: r["Variant SKU"],
                "Gi√° Gi·∫£m": money(r["Variant Price"]), // Gi√° m·ªõi sau c·∫≠p nh·∫≠t
                "Gi√° G·ªëc": money(r["Variant Compare At Price"]), // Gi√° g·ªëc m·ªõi sau c·∫≠p nh·∫≠t
                "T·ªìn kho":
                  r["Inventory Quantity"] || r["Variant Inventory Qty"] || "", // t·ªìn kho m·ªõi
                Status: r.Status || "", // Status m·ªõi
              });
            }
          });
        } else if (selectedMode === "file" && fileUpdateData.length) {
          const map = {};
          for (let j = 1; j < fileUpdateData.length; j++) {
            const [sku, p, c, q] = fileUpdateData[j];
            if (sku) map[sku.toString().trim()] = { p, c, q };
          }
          result.forEach((r) => {
            if (
              r["Product Category"] !==
              "Apparel & Accessories > Jewelry > Watches"
            )
              return;
            if (!r["Variant SKU"]) return;
            const u = map[r["Variant SKU"]];
            if (u) {
              let changed = false;

              // Gi√° gi·∫£m
              if (u.p !== "" && u.p != null) {
                r["Variant Price"] = Number(u.p);
              } else {
                r["Variant Price"] = 0;
              }
              changed = true;

              // Gi√° g·ªëc
              if (u.c !== "" && u.c != null) {
                r["Variant Compare At Price"] = Number(u.c);
              } else {
                r["Variant Compare At Price"] = 0;
              }
              changed = true;

              if (changed) {
                updatedHandles.add(r.Handle);
                if (!updatedSKUSet.has(r["Variant SKU"])) {
                  updatedSKUSet.add(r["Variant SKU"]);
                  const masterRow = master.find(
                    (m) => m["Variant SKU"] === r["Variant SKU"]
                  );
                  preview.push({
                    STT: i++,
                    SKU: r["Variant SKU"],
                    "Gi√° Gi·∫£m": money(r["Variant Price"]),
                    "Gi√° G·ªëc": money(r["Variant Compare At Price"]),
                    "T·ªìn kho":
                      r["Inventory Quantity"] ||
                      masterRow?.["Variant Inventory Qty"] ||
                      "",
                    Status: r.Status || masterRow?.Status || "",
                  });
                }
              }
            }
          });
        }

        // ‚úÖ H·ªèi user c√≥ mu·ªën Publish c√°c m·∫´u n√†y kh√¥ng
        if (preview.length) {
          const publishChoice = window.confirm(
            "B·∫°n c√≥ mu·ªën Publish to√†n b·ªô c√°c m·∫´u n√†y kh√¥ng?\nCh·ªçn 'OK' = C√≥, 'Cancel' = Gi·ªØ nguy√™n"
          );

          if (publishChoice) {
            // C·∫≠p nh·∫≠t t·∫•t c·∫£ c√°c d√≤ng trong result c√≥ trong preview
            preview.forEach((p) => {
              const row = result.find((r) => r["Variant SKU"] === p.SKU);
              if (row) {
                row["Published"] = "TRUE";
                row["Status"] = "active";
                p.Published = "TRUE"; // hi·ªÉn th·ªã lu√¥n
                p.Status = "active"; // hi·ªÉn th·ªã lu√¥n
              }
            });
          }
          // N·∫øu ng∆∞·ªùi d√πng ch·ªçn Kh√¥ng, kh√¥ng l√†m g√¨, gi·ªØ nguy√™n gi√° tr·ªã
        }

        renderPreview(preview);
      }

      function renderPreview(rows) {
        if (!rows.length) {
          previewTable.innerHTML = "";
          return;
        }
        previewTable.innerHTML =
          "<tr>" +
          Object.keys(rows[0])
            .map((h) => `<th>${h}</th>`)
            .join("") +
          "</tr>" +
          rows
            .map(
              (r) =>
                "<tr>" +
                Object.values(r)
                  .map((v) => `<td>${v}</td>`)
                  .join("") +
                "</tr>"
            )
            .join("");
      }

      function exportFile() {
        if (!result.length) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu");
        const scope = document.querySelector(
          'input[name="exportScope"]:checked'
        ).value;
        const type = exportType.value;
        let data = [];
        if (scope === "updated")
          data = result.filter((r) => updatedHandles.has(r.Handle));
        else data = result;
        if (!data.length) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t");

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Updated");
        const ts = new Date().toISOString().slice(0, 16).replace(/[:T]/g, "-");

        if (type === "csv") {
          const csv = XLSX.utils.sheet_to_csv(ws);
          const a = document.createElement("a");
          a.href = URL.createObjectURL(
            new Blob([csv], { type: "text/csv;charset=utf-8" })
          );
          a.download = `WatchPrice_${scope}_${ts}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        } else XLSX.writeFile(wb, `WatchPrice_${scope}_${ts}.xlsx`);
      }

      function exportMaison() {
        if (!result.length) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu");
        const changedData = result.filter((r) => updatedHandles.has(r.Handle));
        if (!changedData.length)
          return alert("Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o thay ƒë·ªïi gi√° ƒë·ªÉ xu·∫•t");

        const brands = [
          ...new Set(changedData.map((r) => r.Vendor).filter((v) => v)),
        ];
        const wb = XLSX.utils.book_new();

        brands.forEach((b) => {
          const data = changedData.filter((r) => r.Vendor === b);
          if (!data.length) return;
          const sheetData = data.map((r, i) => {
            if (r["Variant Price"] > r["Variant Compare At Price"])
              r["Variant Compare At Price"] = r["Variant Price"];
            const masterRow = master.find(
              (m) => m["Variant SKU"] === r["Variant SKU"]
            );
            return {
              STT: i + 1,
              SKU: r["Variant SKU"],
              "Gi√° Gi·∫£m": r["Variant Price"] || "",
              "Gi√° G·ªëc": r["Variant Compare At Price"] || "0",
              "% gi·∫£m": r["Variant Compare At Price"]
                ? Math.round(
                    ((r["Variant Compare At Price"] - r["Variant Price"]) *
                      100) /
                      r["Variant Compare At Price"]
                  )
                : "",
              "T·ªìn kho":
                r["Variant Inventory Qty"] ||
                masterRow?.["Variant Inventory Qty"] ||
                "",
              Status: r.Status || masterRow?.Status || "",
            };
          });
          const ws = XLSX.utils.json_to_sheet(sheetData);
          XLSX.utils.book_append_sheet(wb, ws, b);
        });

        const ts = new Date().toISOString().slice(0, 16).replace(/[:T]/g, "-");
        XLSX.writeFile(wb, `Maison_Gosumo_Updated_${ts}.xlsx`);
      }

      function undo() {
        result = JSON.parse(JSON.stringify(backup));
        updatedHandles.clear();
        updatedSKUSet.clear();
        previewTable.innerHTML = "";
      }
    </script>
  </body>
</html>
